{% extends "base.html" %}
{% set resumo_dns = resultados.resumo_dns|default({}) %}
{% set resumo_scan = resultados.resumo_scan|default({}) %}
{% set decisao_ia = resultados.decisao_ia|default({}) %}
{% set nmap_avancado = resultados.nmap_avancado|default({}) %}

{% block title %}Relat√≥rio de Pentest Completo - {{ resultados.alvo_original|default('N/A') }}{% endblock %}

{% block header %}
<h1>Relat√≥rio de Pentest Completo</h1>
<p>Alvo: <strong>{{ resultados.alvo_original|default('N/A') }}</strong></p>
<p>Data: <strong>{{ resultados.timestamp_inicio|default('N/A') }}</strong></p>
<p>Fase: <strong>{{ resultados.fase|default('N/A') }}</strong></p>
{% endblock %}

{% block content %}
<div class="summary">
  <h2>Resumo Executivo</h2>
  <table>
    <tr>
      <th>Status Geral</th>
      <td class="{{ 'status-success' if resultados.sucesso_geral else 'status-error' }}">
        {{ 'Sucesso' if resultados.sucesso_geral else 'Falha' }}
      </td>
    </tr>
    <tr>
      <th>Tipo de Alvo</th>
      <td>{{ (resumo_dns.tipo_alvo|default('N/A'))|title }}</td>
    </tr>
    <tr>
      <th>Hosts Ativos</th>
      <td>{{ resumo_scan.hosts_ativos|default(0) }}</td>
    </tr>
    <tr>
      <th>Total de Portas Abertas</th>
      <td>{{ resumo_scan.total_portas_abertas|default(0) }}</td>
    </tr>
    {% if decisao_ia %}
    <tr>
      <th>Prioridade IA</th>
      <td class="{{ 'status-success' if decisao_ia.prioridade == 'alta' else 'status-warning' if decisao_ia.prioridade == 'media' else 'status-info' }}">
        {{ decisao_ia.prioridade|default('N/A')|title }}
      </td>
    </tr>
    {% endif %}
  </table>
</div>

{% if resumo_dns %}
<div class="section">
  <h2>üìç Resolu√ß√£o DNS</h2>
  <div class="info-box">
    <table>
      {% if resumo_dns.tipo_alvo == 'dominio' %}
        <tr><th>IP Principal</th><td>{{ resumo_dns.ip_principal|default('N/A') }}</td></tr>
        <tr><th>Total de IPs</th><td>{{ resumo_dns.total_ips|default(0) }}</td></tr>
        <tr><th>Possui IPv6</th><td>{{ 'Sim' if resumo_dns.possui_ipv6 else 'N√£o' }}</td></tr>
        <tr><th>Possui MX</th><td>{{ 'Sim' if resumo_dns.possui_mx else 'N√£o' }}</td></tr>
        {% if resumo_dns.ips_encontrados %}
        <tr><th>IPs Encontrados</th><td>{{ resumo_dns.ips_encontrados|join(', ') }}</td></tr>
        {% endif %}
      {% else %}
        <tr><th>IP</th><td>{{ resumo_dns.ip|default('N/A') }}</td></tr>
        <tr><th>Hostname Principal</th><td>{{ resumo_dns.hostname_principal|default('N/A') }}</td></tr>
        <tr><th>Total de Dom√≠nios</th><td>{{ resumo_dns.total_dominios|default(0) }}</td></tr>
        <tr><th>Resolu√ß√£o Reversa</th><td>{{ 'Sim' if resumo_dns.possui_resolucao_reversa else 'N√£o' }}</td></tr>
        {% if resumo_dns.dominios_encontrados %}
        <tr><th>Dom√≠nios Encontrados</th><td>{{ resumo_dns.dominios_encontrados|join(', ') }}</td></tr>
        {% endif %}
      {% endif %}
    </table>
  </div>
</div>
{% endif %}

{% if resumo_scan and resumo_scan.hosts_com_portas_abertas %}
<div class="section">
  <h2>üîç Varredura de Portas</h2>
  
  <div class="info-box">
    <h3>Estat√≠sticas Gerais</h3>
    <ul>
      <li><strong>Total de IPs Escaneados:</strong> {{ resumo_scan.total_ips_scaneados|default(0) }}</li>
      <li><strong>Hosts Ativos:</strong> {{ resumo_scan.hosts_ativos|default(0) }}</li>
      <li><strong>Total de Portas Abertas:</strong> {{ resumo_scan.total_portas_abertas|default(0) }}</li>
    </ul>
  </div>

  {% for host in resumo_scan.hosts_com_portas_abertas %}
  <div class="info-box">
    <h3>Host: {{ host.ip }}</h3>
    <p><strong>Portas Abertas:</strong> {{ host.portas_abertas }} portas</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; margin: 10px 0;">
      {% for porta in host.portas %}
        <span style="background-color: #e8f5e8; border: 1px solid #4caf50; padding: 3px 6px; border-radius: 3px; text-align: center; font-family: monospace;">
          {{ porta }}
        </span>
      {% endfor %}
    </div>
  </div>
  {% endfor %}

  {% if resultados.scan_portas %}
  <div class="info-box">
    <h3>Detalhes T√©cnicos</h3>
    {% for ip, scan_data in resultados.scan_portas.items() %}
      {% if scan_data.dados and scan_data.dados.hosts %}
        {% for host in scan_data.dados.hosts %}
          <div style="margin-bottom: 15px;">
            <h4>{{ host.endereco }} ({{ host.status }})</h4>
            {% if host.portas %}
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: #f5f5f5;">
                  <th style="border: 1px solid #ddd; padding: 8px;">Porta</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">Protocolo</th>
                  <th style="border: 1px solid #ddd; padding: 8px;">Estado</th>
                </tr>
              </thead>
              <tbody>
                {% for porta in host.portas %}
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ porta.numero }}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ porta.protocolo }}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                    <span style="color: {{ '#4caf50' if porta.estado == 'open' else '#f44336' }};">
                      {{ porta.estado }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

{% if decisao_ia %}
<div class="section">
  <h2>ü§ñ An√°lise de IA</h2>
  
  <div class="info-box">
    <table>
      <tr><th>Fonte</th><td>{{ decisao_ia.fonte_decisao|default('N/A') }}</td></tr>
      <tr><th>Executar Nmap Avan√ßado</th><td>{{ 'Sim' if decisao_ia.executar_nmap_avancado else 'N√£o' }}</td></tr>
      <tr><th>Prioridade</th><td>{{ decisao_ia.prioridade|default('N/A')|title }}</td></tr>
      <tr><th>Tempo Estimado</th><td>{{ decisao_ia.tempo_estimado|default('N/A') }}</td></tr>
    </table>
  </div>

  {% if decisao_ia.justificativa_ia %}
  <div class="info-box">
    <h3>Justificativa da IA</h3>
    <p>{{ decisao_ia.justificativa_ia }}</p>
  </div>
  {% endif %}

  {% if decisao_ia.modulos_recomendados %}
  <div class="info-box">
    <h3>M√≥dulos Recomendados</h3>
    <ul>
      {% for modulo in decisao_ia.modulos_recomendados %}
        <li>{{ modulo }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if decisao_ia.portas_prioritarias %}
  <div class="info-box">
    <h3>Portas Priorit√°rias</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; margin: 10px 0;">
      {% for porta in decisao_ia.portas_prioritarias %}
        <span style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 3px 6px; border-radius: 3px; text-align: center; font-family: monospace;">
          {{ porta }}
        </span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if decisao_ia.analise_local %}
  <div class="info-box">
    <h3>An√°lise Local</h3>
    <ul>
      <li><strong>Servi√ßos Web Detectados:</strong> {{ decisao_ia.analise_local.servicos_web_detectados|default(0) }}</li>
      <li><strong>Servi√ßos Cr√≠ticos Detectados:</strong> {{ decisao_ia.analise_local.servicos_criticos_detectados|default(0) }}</li>
      <li><strong>N√≠vel de Interesse:</strong> {{ decisao_ia.analise_local.nivel_interesse|default('N/A')|title }}</li>
      <li><strong>Recomenda√ß√£o:</strong> {{ decisao_ia.analise_local.recomendacao_local|default('N/A') }}</li>
      {% if decisao_ia.analise_local.portas_interessantes %}
      <li><strong>Portas Interessantes:</strong> {{ decisao_ia.analise_local.portas_interessantes|join(', ') }}</li>
      {% endif %}
    </ul>
  </div>
  {% endif %}
</div>
{% endif %}

{% if nmap_avancado and nmap_avancado.executado %}
<div class="section">
  <h2>üî¨ Nmap Avan√ßado</h2>
  
  <div class="info-box">
    <table>
      <tr><th>Status</th><td class="{{ 'status-success' if nmap_avancado.sucesso_geral else 'status-error' }}">
        {{ 'Sucesso' if nmap_avancado.sucesso_geral else 'Falha' }}
      </td></tr>
      <tr><th>IPs Analisados</th><td>{{ nmap_avancado.ips_analisados|length if nmap_avancado.ips_analisados else 0 }}</td></tr>
      <tr><th>M√≥dulos Executados</th><td>{{ nmap_avancado.modulos_executados|length if nmap_avancado.modulos_executados else 0 }}</td></tr>
    </table>
  </div>

  {% if nmap_avancado.resumo_geral %}
  <div class="info-box">
    <h3>Resumo Geral</h3>
    <ul>
      <li><strong>Total de Vulnerabilidades:</strong> {{ nmap_avancado.resumo_geral.total_vulnerabilidades|default(0) }}</li>
      <li><strong>Servi√ßos Detectados:</strong> {{ nmap_avancado.resumo_geral.total_servicos_detectados|default(0) }}</li>
      {% if nmap_avancado.resumo_geral.hosts_com_vulnerabilidades %}
      <li><strong>Hosts com Vulnerabilidades:</strong> {{ nmap_avancado.resumo_geral.hosts_com_vulnerabilidades|join(', ') }}</li>
      {% endif %}
      {% if nmap_avancado.resumo_geral.servicos_criticos_encontrados %}
      <li><strong>Servi√ßos Cr√≠ticos:</strong> {{ nmap_avancado.resumo_geral.servicos_criticos_encontrados|join(', ') }}</li>
      {% endif %}
    </ul>
  </div>
  {% endif %}

  {% if nmap_avancado.resultados_por_modulo %}
  <div class="info-box">
    <h3>Resultados por M√≥dulo</h3>
    {% for modulo, resultado in nmap_avancado.resultados_por_modulo.items() %}
      <div style="margin-bottom: 15px; padding: 10px; border-left: 3px solid #007acc;">
        <h4>{{ modulo }}</h4>
        <pre style="background-color: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto;">{{ resultado|tojson(indent=2) }}</pre>
      </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

<div class="section">
  <h2>üìã Pr√≥ximos Passos Recomendados</h2>
  <ul>
    {% if resultados.sucesso_geral %}
      {% if resumo_scan.total_portas_abertas > 0 %}
        <li>Analisar servi√ßos em execu√ß√£o nas portas abertas</li>
        <li>Executar testes de vulnerabilidades espec√≠ficas</li>
        <li>Verificar configura√ß√µes de seguran√ßa dos servi√ßos</li>
        {% if decisao_ia and decisao_ia.modulos_recomendados %}
          {% for modulo in decisao_ia.modulos_recomendados %}
            <li>{{ modulo }}</li>
          {% endfor %}
        {% endif %}
      {% else %}
        <li>Verificar se o host est√° realmente ativo</li>
        <li>Tentar varredura UDP para servi√ßos n√£o TCP</li>
        <li>Verificar firewalls que possam estar bloqueando</li>
      {% endif %}
    {% else %}
      <li>Verificar conectividade de rede</li>
      <li>Confirmar se o alvo est√° correto e acess√≠vel</li>
      <li>Revisar configura√ß√µes de firewall</li>
    {% endif %}
  </ul>
</div>

<div class="section">
  <h2>üìä Informa√ß√µes T√©cnicas</h2>
  <div class="info-box meta">
    <p><strong>Timestamp In√≠cio:</strong> {{ resultados.timestamp_inicio|default('N/A') }}</p>
    <p><strong>Timestamp Fim:</strong> {{ resultados.timestamp_fim|default('N/A') }}</p>
    <p><strong>Fase:</strong> {{ resultados.fase|default('N/A') }}</p>
    {% if resultados.scan_portas %}
      {% for ip, scan_data in resultados.scan_portas.items() %}
        {% if scan_data.comando %}
        <p><strong>Comando Executado ({{ ip }}):</strong> <code>{{ scan_data.comando }}</code></p>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
</div>
{% endblock %}
