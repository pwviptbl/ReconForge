"""
Plugin para Sugestão de Exploits Públicos
"""

import subprocess
import shutil
import os
import time
import json
from typing import Dict, Any, List
from pathlib import Path

import sys
sys.path.append(str(Path(__file__).parent.parent))

from core.plugin_base import BasePlugin, PluginResult


class ExploitSuggesterPlugin(BasePlugin):
    """
    Plugin que busca por exploits públicos correspondentes às
    vulnerabilidades (CVEs) encontradas.
    """

    def __init__(self):
        super().__init__()
        self.name = "ExploitSuggester"
        self.description = "Busca por exploits públicos (Searchsploit) para as CVEs encontradas."
        self.version = "1.0.0"
        self.requirements = ["searchsploit"]
        self.category = "vulnerability"
        self.supported_targets = ["*"] # Processa dados, não alvos
        self._searchsploit_path = None
        self._searchsploit_debug = ""

    def execute(self, target: str, context: Dict[str, Any], **kwargs) -> PluginResult:
        """Busca por exploits para as CVEs no contexto"""
        start_time = time.time()

        # Verificar se searchsploit está disponível
        if not self._check_searchsploit_available():
            return PluginResult(
                success=False,
                plugin_name=self.name,
                execution_time=time.time() - start_time,
                data={},
                error=f"Searchsploit não está instalado ou não está no PATH. {self._searchsploit_debug}".strip()
            )

        # Extrair vulnerabilidades com CVEs do contexto
        vulnerabilities = context.get('vulnerabilities', [])
        all_cves = set()
        for vuln in vulnerabilities:
            if 'cves' in vuln:
                all_cves.update(vuln['cves'])
            if 'cve' in vuln:
                all_cves.add(vuln['cve'])
            title = vuln.get('title', '')
            if isinstance(title, str) and title.upper().startswith('CVE-'):
                all_cves.add(title.upper())

        if not all_cves:
            return PluginResult(
                success=True,
                plugin_name=self.name,
                execution_time=time.time() - start_time,
                data={},
                summary="Nenhuma CVE encontrada para buscar exploits."
            )

        # Buscar exploits para cada CVE
        exploit_suggestions = self._find_exploits_for_cves(list(all_cves))

        execution_time = time.time() - start_time

        return PluginResult(
            success=True,
            plugin_name=self.name,
            execution_time=execution_time,
            data={'exploits': exploit_suggestions},
            summary=f"Encontradas {len(exploit_suggestions)} sugestões de exploits."
        )

    def _check_searchsploit_available(self) -> bool:
        """Verifica se searchsploit está disponível no sistema"""
        try:
            self._searchsploit_debug = ""
            self._searchsploit_path = shutil.which('searchsploit')
            if not self._searchsploit_path:
                for candidate in ("/usr/bin/searchsploit", "/usr/local/bin/searchsploit"):
                    if Path(candidate).is_file():
                        self._searchsploit_path = candidate
                        break
            if not self._searchsploit_path:
                self._searchsploit_debug = f"(PATH={os.environ.get('PATH', '')})"
                return False
            result = subprocess.run(
                [self._searchsploit_path, '-h'],
                capture_output=True,
                text=True,
                timeout=5
            )
            if result.returncode == 0:
                return True
            combined = f"{result.stdout or ''}\n{result.stderr or ''}"
            if "Usage: searchsploit" in combined:
                return True
            self._searchsploit_debug = (
                f"(bin={self._searchsploit_path} rc={result.returncode} "
                f"stderr={result.stderr.strip()[:120]!r})"
            )
            return False
        except (subprocess.TimeoutExpired, FileNotFoundError):
            self._searchsploit_debug = f"(PATH={os.environ.get('PATH', '')})"
            return False

    def _find_exploits_for_cves(self, cves: List[str]) -> List[Dict[str, Any]]:
        """Usa searchsploit para encontrar exploits para uma lista de CVEs"""
        suggestions = []
        for cve in cves:
            try:
                # Usar --json para facilitar o parsing
                cmd = [self._searchsploit_path or 'searchsploit', '--cve', cve, '--json']

                result = subprocess.run(
                    cmd,
                    capture_output=True,
                    text=True,
                    timeout=30
                )

                if result.returncode == 0 and result.stdout:
                    # O output JSON do searchsploit é um objeto com uma chave "RESULTS_EXPLOIT"
                    data = json.loads(result.stdout)
                    exploits = data.get("RESULTS_EXPLOIT", [])

                    if exploits:
                        suggestions.append({
                            'cve': cve,
                            'exploits': [
                                {
                                    'title': e.get('Title'),
                                    'path': e.get('Path'),
                                    'type': e.get('Type'),
                                    'platform': e.get('Platform')
                                }
                                for e in exploits
                            ]
                        })

            except (subprocess.TimeoutExpired, json.JSONDecodeError, FileNotFoundError):
                # Ignorar erros para um CVE específico e continuar
                continue

        return suggestions
